#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk
include /usr/share/dpkg/vendor.mk

export CROSS_COMPILE=$(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)-
export LDFLAGS = $(shell DEB_BUILD_MAINT_OPTIONS=hardening=+all dpkg-buildflags --get LDFLAGS)
export CXFLAGS = $(shell DEB_BUILD_MAINT_OPTIONS=hardening=+all dpkg-buildflags --get CFLAGS) \
	  $(shell DEB_BUILD_MAINT_OPTIONS=hardening=+all dpkg-buildflags --get CPPFLAGS)

export DEBIAN="yes"
export EXTRAVERSION=$(DEB_VENDOR) $(DEB_VERSION)

# these are reversed in the Makefile
export CONFFILE="/etc/mdadm/mdadm.conf"
export CONFFILE2="/etc/mdadm.conf"

PATCHES := debian/patches
APPLD := .pc/applied-patches

$(APPLD):
	QUILT_PATCHES=$(PATCHES) quilt push -a

patch: $(APPLD)
	:

unpatch:
	quilt pop -a || true

override_dh_auto_build: patch
	dh_auto_build

%:
	dh $@

override_dh_auto_clean: unpatch
	dh_auto_clean
	# remove generated files
	for file in $$(find . -type f -name "*.in"); \
	do \
		rm -f "$$(dirname "$${file}")"/"$$(basename "$${file}" .in)"; \
	done

override_dh_install:
	dh_install
	mkdir -p $(CURDIR)/debian/mdadm/etc/mdadm
	chmod +x $(CURDIR)/debian/mdadm/usr/share/mdadm/mdcheck

override_dh_installsystemd:

override_dh_installinit:
	dh_installinit --init-script=mdadm-waitidle --no-start -- stop 98 0 6 .
	dh_installinit -- defaults 25
